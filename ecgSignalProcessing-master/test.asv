function processAllEKGDataInDirectory()
    % Let the user select a directory
    folderPath = uigetdir;
    referenceSignal = 're'
    if folderPath == 0
        fprintf('No folder selected, operation cancelled.\n');
        return;
    end
    
    % Find all CSV files in the selected directory
    csvFiles = dir(fullfile(folderPath, '*.csv'));
    
    % Loop through each file and process it
    for i = 1:length(csvFiles)
        originalCsvFilePath = fullfile(folderPath, csvFiles(i).name);
        fprintf('Processing %s\n', originalCsvFilePath);
        
        % Generate the new filename for the filtered data
        [path, name, ~] = fileparts(originalCsvFilePath);
        filteredCsvFilePath = fullfile(path, [name 'filtered.csv']);
        
        % Process the EKG data
        [ekgFiltered, snrBefore, snrAfter, rmseBefore, rmseAfter] = processEKGData(originalCsvFilePath, 250, 250);
        
        % Save the filtered signal
        writematrix(ekgFiltered, filteredCsvFilePath);
        fprintf('Filtered EKG data saved to: %s\n', filteredCsvFilePath);
        
        % Print out signal quality metrics
        fprintf('RMSE before: %f\n', rmseBefore);
        fprintf('RMSE After: %f\n',rmseAfter);
        fprintf('SNR before filtration: %f\n', snrBefore);
        fprintf('SNR after filtration: %f\n', snrAfter);
    end
end

function [ekgFiltered, snrBefore, snrAfter, rmseBefore, rmseAfter] = processEKGData(csvFilePath, referenceSignal, Fs_original, Fs_new)
    % Load EKG data from a CSV file
    data1 = readmatrix(csvFilePath);
    
    % Decimate the signal to the new sampling rate
    decimationFactor = Fs_original / Fs_new;
    ekgSignal = downsample(data1(5:end, 2), decimationFactor);
    
    % Initial signal quality assessment (before filtering)
    [rmseBefore, snrBefore] = assessSignalQuality(ekgSignal, referenceSignal);
    
    % Filter operations
    ekgFiltered = removeBaselineWander(ekgSignal, Fs_new);
    ekgFiltered = removeUnwantedFrequencies(ekgFiltered, Fs_new);
    
    % Signal quality assessment (after filtering)
    [rmseAfter, snrAfter] = assessSignalQuality(ekgFiltered, referenceSignal);
    
    % Plot signals for visual comparison
    figure;
    subplot(2, 1, 1);
    plot(ekgSignal);
    title('Raw EKG Signal');
    
    subplot(2, 1, 2);
    plot(ekgFiltered);
    title('Filtered EKG Signal');
end

function [rmseValue, snrValue] = assessSignalQuality(mySignal, referenceSignal)
    % Ensure both signals are of the same length for comparison
    minLen = min(length(mySignal), length(referenceSignal));
    mySignal = mySignal(1:minLen);
    referenceSignal = referenceSignal(1:minLen);
    
    % Normalize signals (optional but recommended for consistent scale)
    mySignal = (mySignal - mean(mySignal)) / std(mySignal);
    referenceSignal = (referenceSignal - mean(referenceSignal)) / std(referenceSignal);
    
    % Calculate SNR
    snrValue = snr(referenceSignal, referenceSignal - mySignal);
    
    % Calculate RMSE
    rmseValue = sqrt(mean((mySignal - referenceSignal).^2));
end


function filteredSignal = removeBaselineWander(signal, Fs)
    hpFilt = designfilt('highpassiir', 'FilterOrder', 5, 'HalfPowerFrequency', 0.5, 'SampleRate', Fs, 'DesignMethod', 'butter');
    filteredSignal = filtfilt(hpFilt, signal);
end

function ekgFiltered = removeUnwantedFrequencies(signal, Fs)
    cutoff_freq = 40;
    lpFilt = designfilt('lowpassiir', 'FilterOrder', 5, 'HalfPowerFrequency', cutoff_freq, 'SampleRate', Fs, 'DesignMethod', 'butter');
    ekgFiltered = filtfilt(lpFilt, signal);
end

